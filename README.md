# nicman - Linux网络接口管理工具

一个基于Rust和TUI的现代化Linux网络接口管理工具，提供直观的终端用户界面和强大的网络管理功能。

## ✨ 特性

### 核心功能
- 🔍 **接口列表** - 自动识别物理网卡、虚拟接口、Docker网桥等
- 📊 **实时流量监控** - 显示上下行速率、累计流量、包数统计
- 🔎 **创建者检测** - 识别接口由哪个服务/容器/进程创建，显示详细信息
- 🎯 **统一操作菜单** - 回车键打开操作菜单，包含所有可用操作
- 🗑️ **智能删除** - 根据创建者类型自动选择删除策略，防止自动重启
- ⚙️ **配置管理** - 支持运行时修改和Netplan持久化配置
- 🛡️ **安全保护** - 防止误删系统关键接口，操作前确认

### 接口类型识别
- 🔌 物理网卡 (Physical)
- 🔄 回环接口 (Loopback)
- 🐳 Docker网桥 (Docker)
- 🔐 WireGuard (WireGuard)
- 🌉 网桥 (Bridge)
- 🔗 Veth对 (Veth)
- 📡 VLAN (VLAN)
- 🚇 TUN设备 (Tun)
- 🚰 TAP设备 (Tap)

### 创建者检测与操作
- **systemd服务** - 显示服务名、状态、启动时间，可停止服务
- **Docker容器** - 显示容器ID、名称、镜像，可停止容器
- **进程** - 显示进程ID、名称、命令行，可终止进程
- **NetworkManager连接** - 显示连接名，可断开连接
- **内核模块** - 显示模块名，可卸载模块

### 接口操作
- **物理接口** - 编辑配置、切换DHCP、启用/禁用
- **虚拟接口** - 删除接口、启用/禁用、停止创建者
- **统一菜单** - 回车键打开操作菜单，显示所有可用操作

## 🚀 快速开始

### 系统要求
- Linux系统（Ubuntu 20.04+推荐）
- Rust 1.70+
- root权限（网络配置需要）

### 安装

```bash
# 克隆仓库
git clone https://github.com/yourusername/nicman.git
cd nicman

# 编译
cargo build --release

# 安装到系统
sudo cp target/release/nicman /usr/local/bin/

# 运行
sudo nicman
```

### 使用方法

```bash
# 启动TUI界面
sudo nicman

# 显示版本信息
nicman --version
```

## ⌨️ 快捷键

### 通用快捷键
- `q` - 退出当前窗口/取消操作（所有窗口通用）
- `Enter` - 确认/执行操作（所有确认对话框通用）
- `Esc` - 退出当前窗口/取消操作
- `?` - 显示/隐藏帮助

### 主界面导航
- `↑` / `k` - 上移选择接口
- `↓` / `j` - 下移选择接口
- `r` - 刷新接口列表

### 主界面操作
- `Enter` - 打开操作菜单（显示所有可用操作）
- `e` - 快速编辑配置（仅物理接口）
- `t` - 快速切换DHCP（仅物理接口）
- `x` / `Delete` - 快速删除接口（仅虚拟接口）
- `u` - 启用接口 (Up)
- `d` - 禁用接口 (Down)
- `o` - 创建者操作（已废弃，使用Enter打开菜单）

### 操作菜单
- `↑↓` / `k j` - 选择操作
- `Enter` - 执行选中的操作
- `q` / `Esc` - 退出菜单

### 编辑表单
- `↑↓` / `k j` - 切换字段
- `Enter` - 进入字段编辑模式
- `Esc` - 退出编辑模式（在字段编辑时）
- `s` - 保存配置
- `q` / `Esc` - 取消编辑，返回主界面

### 确认对话框
- `Enter` / `Y` / `y` - 确认操作
- `q` / `N` / `n` / `Esc` - 取消操作

## 📁 项目结构

```
nicman/
├── src/
│   ├── main.rs              # 主程序入口
│   ├── model.rs             # 数据模型定义
│   ├── ui.rs                # TUI界面实现
│   ├── backend/             # 后端模块
│   │   ├── runtime.rs       # 运行时接口管理
│   │   ├── traffic.rs       # 流量监控
│   │   ├── owner_detection.rs  # 创建者检测
│   │   ├── removal.rs       # 智能删除
│   │   └── netplan.rs       # Netplan配置管理
│   └── utils/               # 工具函数
│       ├── command.rs       # 命令执行
│       └── format.rs        # 格式化工具
├── Cargo.toml               # 项目配置
└── README.md                # 项目文档
```

## 🛠️ 技术栈

- **语言**: Rust (Edition 2024)
- **TUI框架**: ratatui 0.26 + crossterm 0.27
- **异步运行时**: tokio 1.35
- **序列化**: serde + serde_yaml + serde_json
- **错误处理**: anyhow + thiserror
- **命令行**: clap 4.4
- **系统调用**: nix 0.27

## 📊 功能演示

### 主界面
```
┌网络接口 (↑↓:选择 Enter:操作 r:刷新 q:退出 ?:帮助)─┐┌接口详情──────────────────┐
│>> � ✅ enp4s0 - ↓ 223 B/s ↑ 161 B/s              ││接口名称: enp4s0          │
│   � ✅ lo - ↓ 79 B/s ↑ 79 B/s                    ││类型: Physical            │
│   🐳 ✅ docker0 - ↓ 0 B/s ↑ 0 B/s                 ││状态: Up                  │
│   � ✅ server_0001 - ↓ 1.2 KB/s ↑ 856 B/s        ││MTU: 1500                 │
│   🔗 ✅ veth1234567 - ↓ 512 B/s ↑ 256 B/s         ││MAC: 00:11:22:33:44:55    │
└───────────────────────────────────────────────────┘│IPv4地址: 192.168.1.100/24│
                                                      │子网掩码: 255.255.255.0   │
                                                      │网关: 192.168.1.1         │
                                                      │DNS: 8.8.8.8,8.8.4.4      │
                                                      └──────────────────────────┘
                                                      ┌流量统计──────────────────┐
                                                      │接收: 17.6 MB (265561 包) │
                                                      │发送: 17.6 MB (265561 包) │
                                                      │速率: ↓ 223 B/s ↑ 161 B/s│
                                                      └──────────────────────────┘
```

### 操作菜单
```
╭─接口操作菜单────────────────────────╮
│ 接口操作 - server_0001              │
│                                     │
│ 接口类型: Tun                       │
│ 创建者: 进程: tincd (PID: 148322)  │
│                                     │
│ 可用操作:                           │
│                                     │
│ ► 删除接口 - 删除虚拟网络接口       │
│   启用接口 - 设置接口状态为UP       │
│   禁用接口 - 设置接口状态为DOWN     │
│   终止进程 - 终止创建者进程         │
│                                     │
│ ↑↓ - 选择  Enter - 执行  q - 取消  │
╰─────────────────────────────────────╯
```

### 编辑配置
```
╭─编辑配置────────────────────────────╮
│ 接口: enp4s0                        │
│                                     │
│ ► IP地址      : 192.168.1.100       │
│   子网掩码    : 255.255.255.0       │
│   网关        : 192.168.1.1         │
│   DNS         : 8.8.8.8,8.8.4.4     │
│                                     │
│ ↑↓ - 切换字段  Enter - 编辑         │
│ s - 保存  q - 取消                  │
╰─────────────────────────────────────╯
```

### 创建者信息显示
```
接口详情:
  接口名称: server_0001
  类型: Tun
  状态: Up
  创建者: 进程: tincd (PID: 148322)
    进程ID: 148322
    进程名: tincd
    命令行: /usr/sbin/tincd -n mynetwork
    操作: 按 Enter 打开操作菜单
```

## 🔒 安全特性

- ✅ **Root权限检查** - 启动时检查root权限
- ✅ **SSH连接接口保护** - 防止删除SSH连接使用的接口
- ✅ **默认路由接口警告** - 删除默认路由接口时显示警告
- ✅ **配置文件自动备份** - 修改配置前自动备份
- ✅ **删除前安全检查** - 所有危险操作都需要确认
- ✅ **系统组件保护** - 防止误操作Docker网桥等系统组件
- ✅ **错误处理** - 操作失败不会导致程序退出

## 🎯 使用场景

### 场景1: 管理物理网卡
1. 选择物理接口（如enp4s0）
2. 按`Enter`打开操作菜单
3. 选择"编辑配置"修改IP/网关/DNS
4. 或选择"切换DHCP"在DHCP和静态IP之间切换

### 场景2: 清理虚拟接口
1. 选择虚拟接口（如tun0、veth等）
2. 查看右侧面板的创建者信息
3. 按`Enter`打开操作菜单
4. 选择"删除接口"或"终止进程"

### 场景3: 管理Docker容器网络
1. 选择veth接口
2. 查看关联的Docker容器信息
3. 按`Enter`打开操作菜单
4. 选择"停止容器"停止容器（veth接口自动消失）

### 场景4: 停止VPN连接
1. 选择tun/tap接口（如server_0001）
2. 查看持有该接口的进程（如tincd、openvpn）
3. 按`Enter`打开操作菜单
4. 选择"终止进程"停止VPN进程

## 💡 高级功能

### 创建者检测原理
- **systemd服务** - 通过接口名匹配systemd服务（如wg-quick@wg0.service）
- **Docker容器** - 通过网络命名空间匹配veth接口和容器
- **进程** - 遍历/proc目录查找持有/dev/net/tun的进程
- **NetworkManager** - 通过nmcli查询连接和设备的关联
- **内核模块** - 通过/sys/class/net检测接口类型

### 智能操作菜单
- **动态生成** - 根据接口类型和创建者动态生成可用操作
- **物理接口** - 显示编辑配置、切换DHCP等操作
- **虚拟接口** - 显示删除接口、停止创建者等操作
- **系统组件** - 自动隐藏不适用的操作（如docker0不显示"停止容器"）

### 配置持久化
- **运行时配置** - 使用`ip`命令立即生效
- **Netplan配置** - 自动更新/etc/netplan配置文件
- **配置备份** - 修改前自动备份原配置
- **DHCP支持** - 支持DHCP和静态IP配置切换

## � 故障排查

### 问题1: 虚拟接口不显示创建者信息
**原因**: 创建者检测逻辑未执行或检测失败
**解决**:
- 确保以root权限运行
- 检查nsenter命令是否可用
- 查看/proc目录权限

### 问题2: 停止Docker容器时程序退出
**原因**: docker0等系统网桥的容器ID是"system"，执行docker stop失败
**解决**: 已修复，系统网桥不显示"停止容器"选项

### 问题3: 编辑配置后不生效
**原因**: 只修改了运行时配置，未更新Netplan配置
**解决**: 程序会同时更新运行时配置和Netplan配置

### 问题4: 无法删除某些虚拟接口
**原因**: 接口由systemd服务或进程持有，删除后自动重建
**解决**: 使用操作菜单中的"停止服务"或"终止进程"选项

## �📝 开发日志

### v0.1.0 (2025-11-14)
**核心功能**:
- ✅ 接口列表和实时流量监控
- ✅ 创建者检测（systemd、Docker、进程、NetworkManager、内核模块）
- ✅ 统一操作菜单（回车键打开）
- ✅ 配置编辑（IP、子网掩码、网关、DNS）
- ✅ DHCP/静态IP切换
- ✅ 接口启用/禁用/删除
- ✅ 创建者操作（停止服务、停止容器、终止进程等）

**UI改进**:
- ✅ 弹窗背景只覆盖弹窗区域
- ✅ 圆角边框，避免边框缺口
- ✅ 接口详情显示子网掩码、网关、DNS
- ✅ 创建者信息详细显示
- ✅ 统一键盘操作（q退出、Enter确认）

**Bug修复**:
- ✅ 修复编辑表单和接口详情数据不一致
- ✅ 修复虚拟接口不显示创建者信息
- ✅ 修复docker0停止操作导致程序退出
- ✅ 修复tun/tap接口创建者检测（支持任意名称）

**创建时间**: 2025-11-14
**最后更新**: 2025-11-14 22:30:00
**版本**: v0.1.0
**状态**: 开发完成，功能测试通过

## 🤝 贡献

欢迎提交Issue和Pull Request！

### 开发指南
```bash
# 克隆仓库
git clone https://github.com/yourusername/nicman.git
cd nicman

# 开发模式运行
sudo cargo run

# 运行测试
cargo test

# 代码格式化
cargo fmt

# 代码检查
cargo clippy
```

## 📄 许可证

MIT License

## 👨‍💻 作者

开发者：AI Assistant
项目地址：https://github.com/yourusername/nicman

## 🙏 致谢

感谢以下开源项目：
- [ratatui](https://github.com/ratatui-org/ratatui) - 优秀的TUI框架
- [crossterm](https://github.com/crossterm-rs/crossterm) - 跨平台终端操作库
- [tokio](https://github.com/tokio-rs/tokio) - 异步运行时
- [anyhow](https://github.com/dtolnay/anyhow) - 错误处理库

## 📚 相关资源

- [Linux网络管理文档](https://www.kernel.org/doc/Documentation/networking/)
- [Netplan配置指南](https://netplan.io/)
- [Docker网络文档](https://docs.docker.com/network/)
- [WireGuard文档](https://www.wireguard.com/)

---

**⚠️ 注意**: 本工具需要root权限运行，请谨慎操作网络配置，建议在测试环境中先熟悉功能。



